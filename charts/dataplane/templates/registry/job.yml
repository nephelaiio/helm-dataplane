{{- $connectSvc := printf "%s-%s" (include "dataplane.strimzi.connect.fullname" .) "connect-api" }}
{{- $connectPort := 8083 }}
{{- $svcName :=  include "dataplane.registry.fullname" . }}
{{- $svcPort := .Values.registry.service.port -}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $svcName }}
spec:
  template:
    metadata:
      {{- with .Values.registry.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "dataplane.registry.selectorLabels" . | nindent 8 }}
    spec:
      restartPolicy: OnFailure
      backoffLimit: 4
      containers:
        - name: connector-restart
          securityContext:
            {{- toYaml .Values.registry.securityContext | nindent 12 }}
          image: {{ .Values.registry.utilImage.repository }}:{{ .Values.registry.utilImage.tag }}
          imagePullPolicy: {{ .Values.registry.utilImage.pullPolicy }}
          resources:
            requests:
              cpu: 500m
              memory: 200Mi
            limits:
              cpu: 500m
              memory: 200Mi
          command:
            - "sh"
            - "-c"
            - >-
              until curl -s http://{{ $svcName }}:{{ $svcPort }}/ -o /dev/null; do
                echo waiting for registry service;
                sleep 10;
              done;
              echo registry service up;
              until curl -s http://{{ $connectSvc }}:{{ $connectPort }}/ -o /dev/null; do
                echo waiting for connect api service;
                sleep 10;
              done;
              echo connect api service up;
              sleep 10;
              echo restarting connectors;
              curl -s http://{{ $connectSvc }}:{{ $connectPort }}/connectors | jq '.[]' -r |
                xargs -I{} curl -s -XPOST http://{{ $connectSvc }}:{{ $connectPort }}/connectors/{}/restart;
              echo connectors restarted;
              echo restarting tasks;
              curl -s http://{{ $connectSvc }}:{{ $connectPort }}/connectors | jq '.[]' -r |
                xargs -I{} bash -c "curl -s http://{{ $connectSvc }}:{{ $connectPort }}/connectors/{}/tasks |
                   jq 'map(.id.task) | .[]' -r |
                   xargs -I[] curl -s -XPOST http://{{ $connectSvc }}:{{ $connectPort }}/connectors/{}/tasks/[]/restart"
              echo tasks restarted;
              tail -f /dev/null;
