{{- $pgSecret := required "kafka postgres cdc secret name is required" .Values.strimzi.connect.secret }}
---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: {{ include "dataplane.strimzi.connect.fullname" . }}
  {{- with .Values.strimzi.connect.labels }}
  labels:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.strimzi.connect.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  image: {{ .Values.strimzi.connect.image }}
  replicas: {{ .Values.strimzi.connect.replicas }}
  bootstrapServers: {{ include "dataplane.strimzi.kafka.bootstrap" . }}:{{ .Values.strimzi.kafka.listener.plain.port }}
  config:
    config.providers: env
    config.providers.env.class: io.strimzi.kafka.EnvVarConfigProvider
  {{- with .Values.strimzi.connect.config }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
  externalConfiguration:
    env:
      - name: POSTGRES_USER
        valueFrom:
          secretKeyRef:
            name: {{ $pgSecret }}
            key: username
      - name: POSTGRES_PASS
        valueFrom:
          secretKeyRef:
            name: {{ $pgSecret }}
            key: password
