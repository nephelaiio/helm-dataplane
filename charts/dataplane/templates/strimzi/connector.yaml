{{- $fullName := include "dataplane.strimzi.connect.fullname" . -}}
{{- $registryName := include "dataplane.registry.fullname" . -}}
{{- $registryPort := .Values.registry.service.port -}}

{{- range $db := .Values.cdc.postgres }}
{{- $dbConnectorName := lower (printf "%s-%s-%s" $fullName $db.servername $db.dbname) }}
{{- $dbSlotName := $dbConnectorName | replace "-" "_" }}
---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: {{ $dbConnectorName }}
  labels:
    strimzi.io/cluster: {{ $fullName }}
spec:
  class: io.debezium.connector.postgresql.PostgresConnector
  tasksMax: 1
  config:
    database.hostname: {{ $db.hostname }}
    database.port: "{{ $db.port | default 5432 }}"
    database.user: "${env:POSTGRES_CDC_USER}"
    database.password: "${env:POSTGRES_CDC_PASS}"
    database.server.name: "{{ $db.servername }}"
    database.dbname: "{{ $db.dbname }}"
    snapshot.new.tables: parallel
    slot.name: "{{ $dbSlotName }}"
    tasks.max: "1"
    {{- if and (hasKey $db "partitions") (ge (len $db.partitions) 1) }}
    table.exclude.list: "{{- range $i, $p := $db.partitions -}}{{- if $i }},{{- end -}}{{ $p.source }}{{- end }}"
    {{- end }}
    key.converter: io.confluent.connect.avro.AvroConverter
    key.converter.schema.registry.url: http://{{ $registryName }}:{{ $registryPort }}
    value.converter: io.confluent.connect.avro.AvroConverter
    value.converter.schema.registry.url: http://{{ $registryName }}:{{ $registryPort }}
    {{- if $db.signaling }}
    signal.data.collection: debezium.signaling
    {{- end }}
    transforms: reroute
    transforms.reroute.type: io.debezium.transforms.ByLogicalTableRouter
    transforms.reroute.topic.regex: (.*)
    transforms.reroute.topic.replacement: cdc.$1

{{- if and (hasKey $db "partitions") (ge (len $db.partitions) 1) }}
{{- range $partition := $db.partitions }}
{{- $partitionSource := required "partition source is required" $partition.source }}
{{- $partitionSink := required "partition sink is required" $partition.sink }}
{{- $partitionConnectorName := lower (printf "%s-%s" $dbConnectorName $partitionSink) | replace "." "-" }}
{{- $partitionSlotName := $partitionConnectorName | replace "-" "_" }}
---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: {{ $partitionConnectorName }}
  labels:
    strimzi.io/cluster: {{ $fullName }}
spec:
  class: io.debezium.connector.postgresql.PostgresConnector
  tasksMax: 1
  config:
    database.hostname: {{ $db.hostname }}
    database.port: "{{ $db.port | default 5432 }}"
    database.user: "${env:POSTGRES_CDC_USER}"
    database.password: "${env:POSTGRES_CDC_PASS}"
    database.server.name: "{{ $db.servername }}"
    database.dbname: "{{ $db.dbname }}"
    snapshot.new.tables: parallel
    plugin.name: pgoutput
    slot.name: {{ $partitionSlotName }}
    tasks.max: "1"
    table.include.list: "{{ $partitionSource }}"
    key.converter: io.confluent.connect.avro.AvroConverter
    key.converter.schema.registry.url: http://{{ $registryName }}:{{ $registryPort }}
    value.converter: io.confluent.connect.avro.AvroConverter
    value.converter.schema.registry.url: http://{{ $registryName }}:{{ $registryPort }}
    {{- if $db.signaling }}
    signal.data.collection: debezium.signaling
    {{- end }}
    transforms: reroute
    transforms.reroute.type: io.debezium.transforms.ByLogicalTableRouter
    transforms.reroute.topic.regex: "^([^\\.]+)\\.([^\\.]+)\\..*"
    transforms.reroute.topic.replacement: "cdc.$1.$2.{{ $partitionSink }}"
{{- end }}
{{- end }}
{{- end }}

---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: {{ $fullName }}-warehouse-sink
  labels:
    strimzi.io/cluster: {{ $fullName }}
spec:
  class: io.confluent.connect.jdbc.JdbcSinkConnector
  tasksMax: 1
  config:
    connection.url: jdbc:postgresql://{{ include "dataplane.warehouse.cluster" . }}:5432/{{ include "dataplane.warehouse.db" . }}
    connection.user: "${env:POSTGRES_DW_USER}"
    connection.password: "${env:POSTGRES_DW_PASS}"
    tasks.max: "1"
    topics.regex: "cdc.(.*)"
    auto.create: true
    key.converter: io.confluent.connect.avro.AvroConverter
    key.converter.schema.registry.url: http://{{ $registryName }}:{{ $registryPort }}
    value.converter: io.confluent.connect.avro.AvroConverter
    value.converter.schema.registry.url: http://{{ $registryName }}:{{ $registryPort }}
    transforms: "unwrap,rename"
    transforms.unwrap.type: io.debezium.transforms.ExtractNewRecordState
    transforms.unwrap.drop.tombstones: false
    transforms.unwrap.delete.handling.mode: rewrite
    transforms.rename.type: org.apache.kafka.connect.transforms.RegexRouter
    transforms.rename.regex: "^cdc\\.([^\\.]*)\\.([^\\.]*)\\.([^\\.]*)"
    transforms.rename.replacement: "$1_$3"
